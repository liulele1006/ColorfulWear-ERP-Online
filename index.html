<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ColorfulWear-七彩虹数码印花 ERP-进出货管理系统</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header Section -->
  <header class="bg-blue-600 text-white py-6">
    <div class="container mx-auto text-center">
      <h1 class="text-3xl font-bold">ColorfulWear ERP 进出货管理</h1>
    </div>
  </header>

  <main class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
    <!-- Form Section -->
    <section class="space-y-6">
      <h2 class="text-2xl font-semibold text-blue-600">新增进出货记录</h2>
      <form id="entryForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="customer_name" class="block text-sm font-medium">客户名称</label>
            <input type="text" id="customer_name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="movement_type" class="block text-sm font-medium">进出货管理</label>
            <select id="movement_type" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="IN">入库</option>
              <option value="OUT">出库</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="date" class="block text-sm font-medium">日期</label>
            <input type="date" id="date" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="style" class="block text-sm font-medium">版型</label>
            <input type="text" id="style" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="base_color" class="block text-sm font-medium">底版颜色</label>
            <input type="text" id="base_color" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="pattern" class="block text-sm font-medium">花型</label>
            <input type="text" id="pattern" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="size" class="block text-sm font-medium">码数</label>
            <input type="text" id="size" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="quantity" class="block text-sm font-medium">数量（件）</label>
            <input type="number" id="quantity" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="unit_price" class="block text-sm font-medium">单价</label>
            <input type="number" id="unit_price" min="0" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="total_price" class="block text-sm font-medium">总价</label>
            <input type="number" id="total_price" readonly step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div>
          <label for="note" class="block text-sm font-medium">备注</label>
          <input type="text" id="note" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <button type="submit" class="mt-4 w-full py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">保存记录</button>
      </form>
    </section>

    <!-- Records Section -->
    <section class="mt-10">
      <h2 class="text-2xl font-semibold text-blue-600">库存记录</h2>
      <button id="exportCSV" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">导出 CSV</button>
      <table id="recordsTable" class="mt-6 w-full table-auto bg-white shadow-md rounded-md">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="px-4 py-2 text-left">客户名称</th>
            <th class="px-4 py-2 text-left">进出货</th>
            <th class="px-4 py-2 text-left">日期</th>
            <th class="px-4 py-2 text-left">版型</th>
            <th class="px-4 py-2 text-left">底版颜色</th>
            <th class="px-4 py-2 text-left">花型</th>
            <th class="px-4 py-2 text-left">码数</th>
            <th class="px-4 py-2 text-left">数量</th>
            <th class="px-4 py-2 text-left">单价</th>
            <th class="px-4 py-2 text-left">总价</th>
            <th class="px-4 py-2 text-left">备注</th>
            <th class="px-4 py-2 text-left">操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    // ⚡ Supabase 配置
    const SUPABASE_URL = "https://oqwburiadlzlussbslbn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xd2J1cmlhZGx6bHVzc2JzbGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTkzMTEsImV4cCI6MjA3Nzg5NTMxMX0.zUglY95hzH-qIvwqaMYkxrJVTYhaj040GfmrL6pYPms";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("entryForm");
    const recordsTable = document.getElementById("recordsTable").querySelector("tbody");
    const quantityInput = document.getElementById("quantity");
    const unitPriceInput = document.getElementById("unit_price");
    const totalPriceInput = document.getElementById("total_price");
    let editingRecordId = null; // 用于存储正在编辑的记录 ID

    // 自动计算总价
    function updateTotal() {
      const q = Number(quantityInput.value) || 0;
      const p = Number(unitPriceInput.value) || 0;
      totalPriceInput.value = (q * p).toFixed(2);
    }
    quantityInput.addEventListener("input", updateTotal);
    unitPriceInput.addEventListener("input", updateTotal);

    // 拉取库存记录
    async function fetchRecords() {
      const { data, error } = await supabaseClient
        .from('inventory_movements')
        .select('*')
        .order('date', { ascending: false });
      if (error) {
        console.error(error);
        return;
      }
      recordsTable.innerHTML = "";
      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2">${r.customer_name}</td>
          <td class="px-4 py-2">${r.movement_type}</td>
          <td class="px-4 py-2">${r.date}</td>
          <td class="px-4 py-2">${r.style || ''}</td>
          <td class="px-4 py-2">${r.base_color || ''}</td>
          <td class="px-4 py-2">${r.pattern || ''}</td>
          <td class="px-4 py-2">${r.size || ''}</td>
          <td class="px-4 py-2">${r.quantity}</td>
          <td class="px-4 py-2">${r.unit_price}</td>
          <td class="px-4 py-2">${r.total_price}</td>
          <td class="px-4 py-2">${r.note || ''}</td>
          <td class="px-4 py-2">
            <button onclick="editRecord(${r.id})" class="text-blue-500 hover:underline">编辑</button> | 
            <button onclick="deleteRecord(${r.id})" class="text-red-500 hover:underline">删除</button>
          </td>
        `;
        recordsTable.appendChild(tr);
      });
    }

    // 保存记录
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const record = {
        customer_name: document.getElementById("customer_name").value,
        movement_type: document.getElementById("movement_type").value,
        date: document.getElementById("date").value,
        style: document.getElementById("style").value,
        base_color: document.getElementById("base_color").value,
        pattern: document.getElementById("pattern").value,
        size: document.getElementById("size").value,
        quantity: Number(document.getElementById("quantity").value),
        unit_price: Number(document.getElementById("unit_price").value),
        total_price: Number(document.getElementById("total_price").value),
        note: document.getElementById("note").value
      };

      // 如果正在编辑记录
      if (editingRecordId) {
        const { data, error } = await supabaseClient
          .from('inventory_movements')
          .update(record)
          .eq('id', editingRecordId);
        if (error) {
          alert("更新失败");
          console.error(error);
          return;
        }
        alert("记录更新成功！");
        editingRecordId = null; // 重置编辑状态
      } else {
        // 否则插入新的记录
        const { data, error } = await supabaseClient.from('inventory_movements').insert([record]);
        if (error) {
          alert("保存失败");
          console.error(error);
          return;
        }
        alert("记录保存成功！");
      }

      form.reset();
      totalPriceInput.value = "";
      fetchRecords(); // 保存后刷新表格
    });

    // 删除记录
    async function deleteRecord(id) {
      const password = prompt("请输入密码以删除记录：");
      if (password !== "106614") {
        alert("密码错误，无法删除！");
        return;
      }

      const { data, error } = await supabaseClient.from('inventory_movements').delete().eq('id', id);
      if (error) {
        alert("删除失败");
        console.error(error);
        return;
      }
      alert("删除成功");
      fetchRecords(); // 删除后刷新表格
    }

    // 编辑记录
    function editRecord(id) {
      const password = prompt("请输入密码以编辑记录：");
      if (password !== "106614") {
        alert("密码错误，无法编辑！");
        return;
      }

      // 拉取记录数据填充到表单
      editingRecordId = id;
      const recordRow = [...recordsTable.querySelectorAll("tr")].find(tr => {
        return tr.querySelector("td").innerText === String(id);
      });

      // 填充数据到表单
      document.getElementById("customer_name").value = recordRow.cells[0].innerText;
      document.getElementById("movement_type").value = recordRow.cells[1].innerText;
      document.getElementById("date").value = recordRow.cells[2].innerText;
      document.getElementById("style").value = recordRow.cells[3].innerText;
      document.getElementById("base_color").value = recordRow.cells[4].innerText;
      document.getElementById("pattern").value = recordRow.cells[5].innerText;
      document.getElementById("size").value = recordRow.cells[6].innerText;
      document.getElementById("quantity").value = recordRow.cells[7].innerText;
      document.getElementById("unit_price").value = recordRow.cells[8].innerText;
      document.getElementById("total_price").value = recordRow.cells[9].innerText;
      document.getElementById("note").value = recordRow.cells[10].innerText;
    }

    // 导出 CSV
    document.getElementById("exportCSV").addEventListener("click", () => {
      let csv = '客户名称,进出货,日期,版型,底版颜色,花型,码数,数量,单价,总价,备注\n';
      Array.from(recordsTable.querySelectorAll("tr")).forEach(tr => {
        const row = Array.from(tr.querySelectorAll("td")).map(td => `"${td.innerText}"`).join(",");
        csv += row + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "库存记录.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    // 页面加载时拉取数据
    fetchRecords();
  </script>

</body>
</html>
