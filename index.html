<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>七彩虹数码印花</title>
  <!-- 引入 Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
<!-- 引入引入库（CDN 方式）用于导出xlsx标准文件 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* ==== 鼠标悬停阴影效果（ 统计报表）==== */
    
    #reportTable tbody tr {
      transition: all 0.25s ease-in-out;
    }

   
    #reportTable tbody tr:hover {
      background-color: #e0f2fe; 
      box-shadow: 0 4px 16px rgba(37, 99, 235, 0.6); 
      transform: scale(1.015);
    }

    /* ==== 固定高度滚动容器 ==== */
    .table-scroll-container {
      max-height: 600px; /* 可根据需要调整高度 */
      overflow-y: auto;
    }

    /* 保持表头固定 */
    .table-scroll-container table thead th {
      position: sticky;
      top: 0;
      background-color: #2563eb; /* 保持表头蓝色 */
      z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- 页面头部 -->
  <header class="bg-blue-600 text-white py-6">
    <div class="container mx-auto text-center">
      <h1 class="text-3xl font-bold">七彩虹数码印花/ColorfulWear-进出货管理系统</h1>
    </div>
  </header>

  <main class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">

    <!-- 新增进出货记录表单 -->
    <section class="space-y-6" id="inventoryFormSection">
      <h2 class="text-2xl font-semibold text-blue-600">新增进出货记录</h2>
      <form id="entryForm" class="space-y-4">
        <!-- 第一行：客户名称 + 进出货类型 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="customer_name" class="block text-sm font-medium">客户名称</label>
            <input list="customerNameOptions" type="text" id="customer_name" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="customerNameOptions"></datalist>
          </div>
          <div>
            <label for="movement_type" class="block text-sm font-medium">进出货管理</label>
            <select id="movement_type" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="IN">入库</option>
              <option value="OUT">出库</option>
            </select>
          </div>
        </div>

        <!-- 第二行：日期 + 版型 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="date" class="block text-sm font-medium">日期</label>
            <input type="date" id="date" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="style" class="block text-sm font-medium">版型</label>
            <input list="styleOptions" type="text" id="style"
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="styleOptions"></datalist>
          </div>
        </div>

        <!-- 第三行：底版颜色 + 花型 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="base_color" class="block text-sm font-medium">底版颜色</label>
            <input list="baseColorOptions" type="text" id="base_color"
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="baseColorOptions"></datalist>
          </div>
          <div>
            <label for="pattern" class="block text-sm font-medium">花型</label>
            <input list="patternOptions" type="text" id="pattern"
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="patternOptions"></datalist>
          </div>
        </div>

        <!-- 第四行：码数 + 数量 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="size" class="block text-sm font-medium">码数</label>
            <input list="sizeOptions" type="text" id="size"
                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="sizeOptions"></datalist>
          </div>
          <div>
            <label for="quantity" class="block text-sm font-medium">数量（件）</label>
            <input type="number" id="quantity" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <!-- 第五行：单价 + 总价 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="unit_price" class="block text-sm font-medium">单价</label>
            <input type="number" id="unit_price" min="0" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="total_price" class="block text-sm font-medium">总价</label>
            <input type="number" id="total_price" readonly step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <!-- 第六行：备注 -->
        <div>
          <label for="note" class="block text-sm font-medium">备注</label>
          <input list="noteOptions" type="text" id="note"
                 class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <datalist id="noteOptions"></datalist>
        </div>

        <!-- 提交按钮 -->
        <button type="submit" class="mt-4 w-full py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">保存记录</button>
      </form>
    </section>

    <div class="mt-10 bg-gradient-to-r from-yellow-400 via-red-400 to-green-400 h-6 w-full rounded-lg shadow-md"></div> <!-- 色块隔离线，定制间距和高度 -->
    
    <!-- 报表统计表单 -->
    <section class="mt-10" id="reportSection">
      <h2 class="mb-6 text-2xl font-semibold text-blue-600">报表统计</h2>
      <form id="reportForm" class="space-y-4">
        <!-- 筛选条件：客户 + 开始日期 + 结束日期 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="reportCustomer" class="block text-sm font-medium">客户筛选</label>
            <input list="customerOptions" type="text" id="reportCustomer" placeholder="可选" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="customerOptions"></datalist>
          </div>
          <div>
            <label for="reportStartDate" class="block text-sm font-medium">开始日期</label>
            <input type="date" id="reportStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="reportEndDate" class="block text-sm font-medium">结束日期</label>
            <input type="date" id="reportEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div class="mt-4">
          <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">生成报表</button>
        </div>
      </form>

      <!-- 报表表格 -->
      
        <table id="reportTable" class="mt-4 w-full table-auto bg-white shadow-md rounded-md hidden text-center">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="text-center">客户名称</th><th class="text-center">进出货</th><th class="text-center">日期</th><th class="text-center">版型</th><th class="text-center">底版颜色</th>
              <th class="text-center">花型</th><th class="text-center">码数</th><th class="text-center">数量</th><th class="text-center">单价</th><th class="text-center">总价</th><th class="text-center">备注</th>
           </tr>
         </thead>
         <tbody class="text-center"></tbody>
       </table>
      

      <!-- 报表总计 -->
      <div id="reportSummary" class="mt-4 hidden p-4 bg-gray-100 rounded-md">
        <p class="font-bold">总数量: <span id="totalQuantity">0</span> 件</p>
        <p class="font-bold">总金额: <span id="totalAmount">0.00</span> 元</p>

      <!-- 新增导出报表按钮 -->
        <button id="exportReportBtn"
              class="mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
        导出报表数据xlsx
       </button>

<button id="batchDeleteBtn" 
  class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:ring-2 focus:ring-red-500 ml-2">
  批量删除
</button>

      </div>
      
    </section>

    <div class="mt-10 bg-gradient-to-r from-yellow-400 via-red-400 to-green-400 h-6 w-full rounded-lg shadow-md"></div> <!-- 色块隔离线，定制间距和高度 -->

    <!--更新数据 -->
    <section class="mt-10">
      <h2 class="text-2xl font-semibold text-blue-600">更新数据</h2>
    </section>


      <!-- 导入现有数据按钮区域 -->
      <div class="p-4 bg-gray-100 rounded-lg shadow-md mt-4">
        <label class="block text-sm font-medium mb-2">导入现有数据xls/xlsx</label>
        <input type="file" id="importFileInput" accept=".csv" class="mb-3 block">
        <button id="importCSVBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none">
          导入到 Supabase
        </button>
        <p id="importStatus" class="text-sm mt-2 text-gray-600"></p>
      </div>
      <!-- 导入 CSV 弹窗（放在 body 里任意位置） -->
      <div id="importDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg w-11/12 max-w-4xl max-h-[80vh] overflow-y-auto relative">
          <h2 class="text-xl font-semibold mb-4 sticky top-0 bg-white py-2">导入明细</h2>
          <div id="importDetailContent" class="space-y-4"></div>
          <div class="flex justify-end mt-4">
            <button id="closeImportDetail" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">关闭</button>
          </div>
        </div>
      </div>
    <!-- 编辑记录弹窗 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto relative">
        <h2 class="text-xl font-semibold mb-4 sticky top-0 bg-white py-2">编辑记录</h2>
        <form id="editForm" class="space-y-4">
          <!-- 编辑表单字段与新增表单相同，只是加上 edit_ 前缀 -->
          <div>
            <label for="edit_customer_name" class="block text-sm font-medium">客户名称</label>
            <input list="customerNameOptionsEdit" type="text" id="edit_customer_name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="customerNameOptionsEdit"></datalist>
          </div>
          <div>
            <label for="edit_movement_type" class="block text-sm font-medium">进出货管理</label>
            <select id="edit_movement_type" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="IN">入库</option>
              <option value="OUT">出库</option>
            </select>
          </div>
          <div>
            <label for="edit_date" class="block text-sm font-medium">日期</label>
            <input type="date" id="edit_date" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_style" class="block text-sm font-medium">版型</label>
            <input list="styleOptionsEdit" type="text" id="edit_style" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="styleOptionsEdit"></datalist>
          </div>
          <div>
            <label for="edit_base_color" class="block text-sm font-medium">底版颜色</label>
            <input list="baseColorOptionsEdit" type="text" id="edit_base_color" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="baseColorOptionsEdit"></datalist>
          </div>
          <div>
            <label for="edit_pattern" class="block text-sm font-medium">花型</label>
            <input list="patternOptionsEdit" type="text" id="edit_pattern" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="patternOptionsEdit"></datalist>
          </div>
          <div>
            <label for="edit_size" class="block text-sm font-medium">码数</label>
            <input list="sizeOptionsEdit" type="text" id="edit_size" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="sizeOptionsEdit"></datalist>
          </div>
          <div>
            <label for="edit_quantity" class="block text-sm font-medium">数量（件）</label>
            <input type="number" id="edit_quantity" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_unit_price" class="block text-sm font-medium">单价</label>
            <input type="number" id="edit_unit_price" min="0" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_total_price" class="block text-sm font-medium">总价</label>
            <input type="number" id="edit_total_price" readonly step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_note" class="block text-sm font-medium">备注</label>
            <input list="noteOptionsEdit" type="text" id="edit_note" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <datalist id="noteOptionsEdit"></datalist>
          </div>
          <!-- 弹窗底部按钮：取消 / 更新 -->
          <div class="flex justify-end mt-4 sticky bottom-0 bg-white py-2">
            <button type="button" id="cancelEdit" class="mr-2 px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">取消</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">更新</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    /****************************
     * Supabase 初始化
     ****************************/
    const SUPABASE_URL = "https://oqwburiadlzlussbslbn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xd2J1cmlhZGx6bHVzc2JzbGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTkzMTEsImV4cCI6MjA3Nzg5NTMxMX0.zUglY95hzH-qIvwqaMYkxrJVTYhaj040GfmrL6pYPms";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEditId = null;      // 当前编辑的记录 ID
    let loadOptionsFunc = null;    // 动态加载下拉选项函数引用
    let refreshReportFunc = null;  // 刷新报表函数引用
    const PASSWORD = "106614";     // 编辑/删除密码



    /****************************
     * 动态加载 datalist 下拉选项（取最后 10 条记录）
     ****************************/
    async function loadDatalistOptions(field, inputId, datalistId) {
      try {
        // 查询最近 100 条数据（按日期倒序）
        const { data, error } = await supabaseClient
          .from('inventory_movements')
          .select(field + ',date') // 取字段和日期
          .order('date', { ascending: false })
          .limit(100);

        if (error) { console.error(error); return; }

        // 去重并取前 10 个（即最近的 10 条唯一值）
        const uniqueValues = Array.from(
          new Set(
            data.map(d => d[field]).filter(v => v)
          )
        ).slice(0, 10);

        // 填充 datalist
        const datalist = document.getElementById(datalistId);
        datalist.innerHTML = '';
        uniqueValues.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          datalist.appendChild(opt);
        });
      } catch (err) {
        console.error("加载下拉菜单失败:", err);
      }
    }

/****************************
 * 加载下拉菜单主函数
 ****************************/
  function initializeDatalists() {
  loadDatalistOptions('customer_name', 'customer_name', 'customerNameOptions');
  loadDatalistOptions('style', 'style', 'styleOptions');
  loadDatalistOptions('base_color', 'base_color', 'baseColorOptions');
  loadDatalistOptions('pattern', 'pattern', 'patternOptions');
  loadDatalistOptions('size', 'size', 'sizeOptions');
  loadDatalistOptions('note', 'note', 'noteOptions');
}

    /****************************
     * 新增进出货记录表单逻辑
     ****************************/
    function mainInventoryForm() {
      const form = document.getElementById("entryForm");
      const quantityInput = document.getElementById("quantity");
      const unitPriceInput = document.getElementById("unit_price");
      const totalPriceInput = document.getElementById("total_price");

      // 计算总价
      function updateTotal() {
        const q = Number(quantityInput.value)||0;
        const p = Number(unitPriceInput.value)||0;
        totalPriceInput.value = (q*p).toFixed(2);
      }
      quantityInput.addEventListener("input", updateTotal);
      unitPriceInput.addEventListener("input", updateTotal);

      form.addEventListener("submit", async e=>{
        e.preventDefault();

        if (!confirm("确定要保存这条记录吗？")) return; // 防止重复提交

        const record = {
          customer_name: document.getElementById("customer_name").value,
          movement_type: document.getElementById("movement_type").value,
          date: document.getElementById("date").value,
          style: document.getElementById("style").value,
          base_color: document.getElementById("base_color").value,
          pattern: document.getElementById("pattern").value,
          size: document.getElementById("size").value,
          quantity: Number(document.getElementById("quantity").value),
          unit_price: Number(document.getElementById("unit_price").value),
          total_price: Number(document.getElementById("total_price").value),
          note: document.getElementById("note").value
        };

        const {error} = await supabaseClient.from('inventory_movements').insert([record]);
        if(error){alert("保存失败");console.error(error);return;}
        alert("记录保存成功！");
       form.reset(); totalPriceInput.value="";
     
       if(refreshReportFunc) refreshReportFunc();

       // 新增：保存后重新加载下拉菜单
       initializeDatalists();
      });
    }

/****************************
 * 独立删除函数
 ****************************/
async function deleteRecord(id, refreshFunc) {
  if (!confirm("确定要删除吗？")) return;
  const { error } = await supabaseClient.from('inventory_movements').delete().eq('id', id);
  if (error) { alert("删除失败"); console.error(error); return; }
  if (typeof refreshFunc === 'function') await refreshFunc();
  if (loadOptionsFunc) loadOptionsFunc();
  if (refreshReportFunc) refreshReportFunc();
}


/****************************
 * 独立编辑函数
 ****************************/
function openEditModal(id, currentData, refreshFunc) {
  currentEditId = id;
  const record = currentData.find(r => r.id == id);
  if (!record) return;

  // 填充表单
  document.getElementById("edit_customer_name").value = record.customer_name;
  document.getElementById("edit_movement_type").value = record.movement_type;
  document.getElementById("edit_date").value = record.date;
  document.getElementById("edit_style").value = record.style || '';
  document.getElementById("edit_base_color").value = record.base_color || '';
  document.getElementById("edit_pattern").value = record.pattern || '';
  document.getElementById("edit_size").value = record.size || '';
  document.getElementById("edit_quantity").value = record.quantity;
  document.getElementById("edit_unit_price").value = record.unit_price;
  document.getElementById("edit_total_price").value = record.total_price;
  document.getElementById("edit_note").value = record.note || '';

  // 显示弹窗
  const modal = document.getElementById("editModal");
  modal.classList.remove("hidden");

  // 绑定事件（只绑定一次）
  document.getElementById("cancelEdit").onclick = () => modal.classList.add("hidden");
  document.getElementById("edit_quantity").oninput = updateEditTotal;
  document.getElementById("edit_unit_price").oninput = updateEditTotal;

  function updateEditTotal() {
    const q = Number(document.getElementById("edit_quantity").value) || 0;
    const p = Number(document.getElementById("edit_unit_price").value) || 0;
    document.getElementById("edit_total_price").value = (q * p).toFixed(2);
  }

  // 提交更新
  document.getElementById("editForm").onsubmit = async (e) => {
    e.preventDefault();
    if (!currentEditId) return;

    const updated = {
      customer_name: document.getElementById("edit_customer_name").value,
      movement_type: document.getElementById("edit_movement_type").value,
      date: document.getElementById("edit_date").value,
      style: document.getElementById("edit_style").value,
      base_color: document.getElementById("edit_base_color").value,
      pattern: document.getElementById("edit_pattern").value,
      size: document.getElementById("edit_size").value,
      quantity: Number(document.getElementById("edit_quantity").value),
      unit_price: Number(document.getElementById("edit_unit_price").value),
      total_price: Number(document.getElementById("edit_total_price").value),
      note: document.getElementById("edit_note").value
    };

    const { error } = await supabaseClient
      .from('inventory_movements')
      .update(updated)
      .eq('id', currentEditId);

    if (error) { alert("更新失败"); console.error(error); return; }

    modal.classList.add("hidden");
    if (typeof refreshFunc === 'function') await refreshFunc();
    if (loadOptionsFunc) loadOptionsFunc();
    if (refreshReportFunc) refreshReportFunc();
  };
}

/****************************
 * 报表统计逻辑（支持批量删除）
 ****************************/
function mainReport() {
  const form = document.getElementById("reportForm");
  const table = document.getElementById("reportTable");
  const reportCustomerInput = document.getElementById("reportCustomer");
  const totalQuantityEl = document.getElementById("totalQuantity");
  const totalAmountEl = document.getElementById("totalAmount");
  const reportSummary = document.getElementById("reportSummary");
  const batchDeleteBtn = document.getElementById("batchDeleteBtn"); // ✅ 批量删除按钮

  let reportData = []; // 当前报表数据
  let selectedIds = new Set(); // ✅ 存储选中行 ID

/****************************
 * 初始化 datalist（固定“所有客户”首位）
 ****************************/
loadOptionsFunc = async () => {
  await loadDatalistOptions('customer_name', 'reportCustomer', 'customerOptions');

  const datalist = document.getElementById('customerOptions');
  // 移除已有“所有客户”，避免重复
  Array.from(datalist.options).forEach(opt => {
    if (opt.value === "所有客户") datalist.removeChild(opt);
  });
  // 创建“所有客户”选项并插入首位
  const allOption = document.createElement("option");
  allOption.value = "所有客户";
  datalist.insertBefore(allOption, datalist.firstChild);

  // ✅ 客户筛选输入框默认为空字符
  reportCustomerInput.value = "";
};
loadOptionsFunc();

  /****************************
   * 生成报表
   ****************************/
  async function generateReport() {
    const start = document.getElementById("reportStartDate").value;
    const end = document.getElementById("reportEndDate").value;
    const customerFilter = reportCustomerInput.value.trim();

    let query = supabaseClient.from('inventory_movements').select('*');
    if (start) query = query.gte('date', start);
    if (end) query = query.lte('date', end);

    // ✅ 客户筛选逻辑
    if (customerFilter === "") {
      query = query.eq('customer_name', '');
    } else if (customerFilter.toLowerCase() !== "所有客户") {
      query = query.ilike('customer_name', `%${customerFilter}%`);
    }
    // 如果 customerFilter 为 "所有客户"，则不过滤客户，显示所有数据

    const { data, error } = await query.order('date', { ascending: false });
    if (error) return console.error(error);
    reportData = data;

    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");
    tbody.innerHTML = "";

    // ✅ 表头
    thead.innerHTML = `
      <tr class="bg-gray-200 text-gray-800 text-base font-semibold">
        <th class="px-3 py-2 text-center">
          <input type="checkbox" id="selectAll" class="cursor-pointer" />
        </th>
        <th class="px-3 py-2">客户</th>
        <th class="px-3 py-2">类型</th>
        <th class="px-3 py-2">日期</th>
        <th class="px-3 py-2">版型</th>
        <th class="px-3 py-2">底色</th>
        <th class="px-3 py-2">花型</th>
        <th class="px-3 py-2">尺码</th>
        <th class="px-3 py-2 text-right">数量</th>
        <th class="px-3 py-2 text-right">单价</th>
        <th class="px-3 py-2 text-right">总价</th>
        <th class="px-3 py-2">备注</th>
        <th class="px-3 py-2 text-center">操作</th>
      </tr>
    `;

    // ✅ 表体渲染
    let totalQuantity = 0, totalAmount = 0;
    data.forEach(r => {
      const quantity = parseFloat(r.quantity) || 0;
      const unitPrice = parseFloat(r.unit_price) || 0;
      const totalPrice = parseFloat(r.total_price) || (quantity * unitPrice);
      totalQuantity += quantity;
      totalAmount += totalPrice;

      const tr = document.createElement("tr");
      tr.classList.add("border-b", "hover:bg-gray-50", "text-sm");
      tr.innerHTML = `
        <td class="px-3 py-2 text-center">
          <input type="checkbox" class="select-row cursor-pointer" data-id="${r.id}" />
        </td>
        <td class="px-3 py-2">${r.customer_name || ''}</td>
        <td class="px-3 py-2">${r.movement_type || ''}</td>
        <td class="px-3 py-2">${r.date || ''}</td>
        <td class="px-3 py-2">${r.style || ''}</td>
        <td class="px-3 py-2">${r.base_color || ''}</td>
        <td class="px-3 py-2">${r.pattern || ''}</td>
        <td class="px-3 py-2">${r.size || ''}</td>
        <td class="px-3 py-2 text-right">${quantity}</td>
        <td class="px-3 py-2 text-right">${unitPrice}</td>
        <td class="px-3 py-2 text-right">${totalPrice}</td>
        <td class="px-3 py-2">${r.note || ''}</td>
        <td class="px-3 py-2 text-center">
          <button class="edit-btn text-blue-600 hover:underline" data-id="${r.id}">编辑</button>
          <button class="delete-btn text-red-600 hover:underline ml-2" data-id="${r.id}">删除</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    totalQuantityEl.textContent = totalQuantity;
    totalAmountEl.textContent = totalAmount.toFixed(2);
    reportSummary.classList.remove("hidden");
    table.classList.remove("hidden");

    // ✅ 行复选框逻辑
    const selectAll = document.getElementById("selectAll");
    const rowCheckboxes = tbody.querySelectorAll(".select-row");

    selectAll.addEventListener("change", e => {
      rowCheckboxes.forEach(cb => {
        cb.checked = e.target.checked;
        if (cb.checked) selectedIds.add(cb.dataset.id);
        else selectedIds.delete(cb.dataset.id);
      });
    });

    rowCheckboxes.forEach(cb => {
      cb.addEventListener("change", e => {
        const id = e.target.dataset.id;
        if (e.target.checked) selectedIds.add(id);
        else selectedIds.delete(id);
      });
    });

    // ✅ 编辑按钮
    tbody.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", e => {
        const pwd = prompt("请输入密码进行编辑：");
        if (pwd !== PASSWORD) return alert("密码错误");
        openEditModal(e.target.dataset.id, reportData, generateReport);
      });
    });

    // ✅ 单条删除按钮
    tbody.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", async e => {
        const pwd = prompt("请输入密码进行删除：");
        if (pwd !== PASSWORD) return alert("密码错误");
        await deleteRecord(e.target.dataset.id, generateReport);
      });
    });
  }

  /****************************
   * 批量删除
   ****************************/
  if (batchDeleteBtn) {
    batchDeleteBtn.addEventListener("click", async () => {
      if (selectedIds.size === 0) return alert("请先选择要删除的记录！");
      const pwd = prompt("请输入密码进行批量删除：");
      if (pwd !== PASSWORD) return alert("密码错误");

      if (!confirm(`确定要删除选中的 ${selectedIds.size} 条记录吗？`)) return;

      const { error } = await supabaseClient
        .from('inventory_movements')
        .delete()
        .in('id', Array.from(selectedIds));

      if (error) { alert("批量删除失败"); console.error(error); return; }
      alert("批量删除成功！");
      selectedIds.clear();
      await generateReport();
      if (loadOptionsFunc) loadOptionsFunc();
    });
  }

  /****************************
   * 表单提交生成报表
   ****************************/
  form.addEventListener("submit", e => {
    e.preventDefault();
    generateReport();
  });

  /****************************
   * 导出 XLSX（样式 + 边框 + 汇总高亮）
   ****************************/
  const exportBtn = document.getElementById("exportReportBtn");
  if (exportBtn) {
    exportBtn.addEventListener("click", () => {
      if (reportData.length === 0) {
        alert("没有可导出的数据，请先生成报表！");
        return;
      }

      const sortedData = [...reportData].sort((a, b) => new Date(a.date) - new Date(b.date));

      const headers = [
        "客户名称", "进出货", "日期", "版型", "底版颜色",
        "花型", "码数", "数量", "单价", "总价", "备注"
      ];

      let totalQuantity = 0;
      let totalAmount = 0;

      const rows = sortedData.map(item => {
        const quantity = parseFloat(item.quantity) || 0;
        const unitPrice = parseFloat(item.unit_price) || 0;
        const totalPrice = parseFloat(item.total_price) || (quantity * unitPrice);
        totalQuantity += quantity;
        totalAmount += totalPrice;
        return [
          item.customer_name || "",
          item.movement_type || "",
          item.date || "",
          item.style || "",
          item.base_color || "",
          item.pattern || "",
          item.size || "",
          quantity,
          unitPrice,
          totalPrice,
          item.note || ""
        ];
      });

      const summaryRow = ["", "", "", "", "", "", "#总件数：", totalQuantity, "#总金额：", totalAmount, ""];
      const worksheetData = [headers, ...rows, [], summaryRow];
      const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

      // 自动列宽
      const colWidths = headers.map((h, i) => {
        const maxLen = Math.max(
          h.length,
          ...rows.map(r => String(r[i] ?? "").length)
        );
        return { wch: Math.max(10, maxLen + 2) };
      });
      worksheet["!cols"] = colWidths;

      // 样式、边框、汇总高亮
      const range = XLSX.utils.decode_range(worksheet["!ref"]);
      const numericCols = [7, 8, 9];
      const totalRowIndex = worksheetData.length - 1;

      for (let R = range.s.r; R <= range.e.r; R++) {
        for (let C = range.s.c; C <= range.e.c; C++) {
          const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
          const cell = worksheet[cellRef];
          if (!cell) continue;

          cell.s = {
            border: {
              top: { style: "thin", color: { rgb: "999999" } },
              bottom: { style: "thin", color: { rgb: "999999" } },
              left: { style: "thin", color: { rgb: "999999" } },
              right: { style: "thin", color: { rgb: "999999" } },
            },
            alignment: {
              vertical: "center",
              horizontal: numericCols.includes(C) ? "right" : "center",
            },
          };

          if (R === 0) { // 表头
            cell.s.fill = { patternType: "solid", fgColor: { rgb: "E0E0E0" } };
            cell.s.font = { bold: true, color: { rgb: "000000" } };
          }

          if (R === totalRowIndex) { // 汇总行
            cell.s.fill = { patternType: "solid", fgColor: { rgb: "FFF9C4" } };
            cell.s.font = { bold: true, color: { rgb: "000000" } };
          }

          if (R > 0 && numericCols.includes(C) && typeof cell.v === "number") {
            cell.t = "n";
            cell.z = "0.00";
          }
        }
      }

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "报表数据");
      const dateStr = new Date().toISOString().split("T")[0];
      const filename = `导出报表数据_${dateStr}.xlsx`;

      try {
        XLSX.writeFile(workbook, filename, { cellStyles: true });
      } catch (err) {
        console.warn("当前 XLSX 库版本不支持样式，将使用基础导出。");
        XLSX.writeFile(workbook, filename);
      }
    });
  }

  // 外部调用刷新报表
  refreshReportFunc = generateReport;
  return { generateReport, reportData };
}



/****************************
 * 导入 XLS/XLSX 数据到 Supabase
 * 自动跳过 # 开头的数据行
 * 判断重复记录使用所有 11 个字段
 * 日期列统一为 YYYY-MM-DD
 ****************************/
document.getElementById("importCSVBtn").addEventListener("click", async () => {
  const fileInput = document.getElementById("importFileInput");
  const statusEl = document.getElementById("importStatus");
  const file = fileInput.files[0];

  if (!file) { 
    alert("请先选择一个 Excel 文件（支持 .xls / .xlsx）！");
    return;
  }

  const fileName = file.name.toLowerCase();
  if (!fileName.endsWith(".xlsx") && !fileName.endsWith(".xls")) {
    alert("文件格式错误！请选择 xls 或 xlsx 格式。");
    return;
  }

  statusEl.textContent = "⏳ 正在读取 Excel 文件，请稍候...";

  const arrayBuffer = await file.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: "array" });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

  const headers = [
    "customer_name","movement_type","date","style","base_color",
    "pattern","size","quantity","unit_price","total_price","note"
  ];

  let insertedCount = 0;
  let updatedCount = 0;
  let insertedList = [];
  let updatedList = [];

  for (let i = 1; i < rows.length; i++) {
    const cols = rows[i];
    if (!cols || cols.length === 0) continue;

    if (String(cols[0] ?? "").trim().startsWith("#")) continue;

    const record = {};
    headers.forEach((h, idx) => record[h] = (cols[idx] ?? "").toString().trim());

    // 日期列统一为 YYYY-MM-DD
    if (record.date) {
      const parsedDate = new Date(record.date);
      if (!isNaN(parsedDate)) {
        record.date = parsedDate.toISOString().split('T')[0];
      } else {
        record.date = null;
      }
    }

    record.quantity = Number(record.quantity) || 0;
    record.unit_price = Number(record.unit_price) || 0;
    record.total_price = Number(record.total_price) || 0;

    // 判断重复：使用所有 11 个字段
    let query = supabaseClient.from("inventory_movements").select("id");
    headers.forEach(h => {
      query = query.eq(h, record[h]);
    });

    const { data: existing, error: checkError } = await query;
    if (checkError) { 
      console.error(checkError); 
      continue; 
    }

    if (existing.length > 0) {
      const { error: updateError } = await supabaseClient
        .from("inventory_movements")
        .update(record)
        .eq("id", existing[0].id);

      if (!updateError) { updatedCount++; updatedList.push(record); }
      else console.error("更新失败：", updateError);
    } else {
      const { error: insertError } = await supabaseClient
        .from("inventory_movements")
        .insert([record]);

      if (!insertError) { insertedCount++; insertedList.push(record); }
      else console.error("插入失败：", insertError);
    }
  }

  statusEl.textContent = `✅ 导入完成：新增 ${insertedCount} 条，更新 ${updatedCount} 条`;

  // 显示明细弹窗
  const modal = document.getElementById("importDetailModal");
  const content = document.getElementById("importDetailContent");
  content.innerHTML = "";

  function buildTable(title, list, color) {
    if (list.length === 0) return;
    const wrapper = document.createElement("div");
    wrapper.innerHTML = `<h3 class="font-bold ${color} mt-4">${title} (${list.length})</h3>`;
    const table = document.createElement("table");
    table.className = "w-full table-auto border border-gray-300";
    table.innerHTML = `
      <thead class="bg-gray-200">
        <tr>${headers.map(h => `<th class="border px-2 py-1 break-words whitespace-normal">${h}</th>`).join("")}</tr>
      </thead>
      <tbody>
        ${list.map(r => `<tr>${headers.map(h => `<td class="border px-2 py-1 break-words whitespace-normal">${r[h] || ""}</td>`).join("")}</tr>`).join("")}
      </tbody>
    `;
    wrapper.appendChild(table);
    content.appendChild(wrapper);
  }

  buildTable("新增记录", insertedList, "text-blue-600");
  buildTable("更新记录", updatedList, "text-green-600");

  modal.classList.remove("hidden");
  document.getElementById("closeImportDetail").addEventListener("click", () => {
    modal.classList.add("hidden");
  });
});



    /****************************
     * 页面加载入口
     ****************************/
    window.onload = ()=>{
      mainInventoryForm();            // 初始化新增表单
      initializeDatalists();   // 初始化下拉菜单
      mainReport();                               // 初始化报表
      }
  </script>

</body>
</html>
