<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>七彩虹数码印花</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header Section -->
  <header class="bg-blue-600 text-white py-6">
    <div class="container mx-auto text-center">
      <h1 class="text-3xl font-bold">七彩虹数码印花/ColorfulWear-进出货管理系统</h1>
    </div>
  </header>

  <main class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">

    <!-- 新增进出货记录 -->
    <section class="space-y-6" id="inventoryFormSection">
      <h2 class="text-2xl font-semibold text-blue-600">新增进出货记录</h2>
      <form id="entryForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="customer_name" class="block text-sm font-medium">客户名称</label>
            <input type="text" id="customer_name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="movement_type" class="block text-sm font-medium">进出货管理</label>
            <select id="movement_type" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="IN">入库</option>
              <option value="OUT">出库</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="date" class="block text-sm font-medium">日期</label>
            <input type="date" id="date" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="style" class="block text-sm font-medium">版型</label>
            <input type="text" id="style" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="base_color" class="block text-sm font-medium">底版颜色</label>
            <input type="text" id="base_color" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="pattern" class="block text-sm font-medium">花型</label>
            <input type="text" id="pattern" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="size" class="block text-sm font-medium">码数</label>
            <input type="text" id="size" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="quantity" class="block text-sm font-medium">数量（件）</label>
            <input type="number" id="quantity" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="unit_price" class="block text-sm font-medium">单价</label>
            <input type="number" id="unit_price" min="0" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="total_price" class="block text-sm font-medium">总价</label>
            <input type="number" id="total_price" readonly step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div>
          <label for="note" class="block text-sm font-medium">备注</label>
          <input type="text" id="note" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <button type="submit" class="mt-4 w-full py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">保存记录</button>
      </form>
    </section>

    <!-- 报表统计 -->
    <section class="mt-10" id="reportSection">
      <h2 class="text-2xl font-semibold text-blue-600">报表统计</h2>
      <form id="reportForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="reportCustomer" class="block text-sm font-medium">客户筛选</label>
            <input type="text" id="reportCustomer" placeholder="可选" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="reportStartDate" class="block text-sm font-medium">开始日期</label>
            <input type="date" id="reportStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="reportEndDate" class="block text-sm font-medium">结束日期</label>
            <input type="date" id="reportEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">生成报表</button>
        </div>
      </form>
      <table id="reportTable" class="mt-6 w-full table-auto bg-white shadow-md rounded-md hidden">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th>客户名称</th><th>进出货</th><th>日期</th><th>版型</th><th>底版颜色</th>
            <th>花型</th><th>码数</th><th>数量</th><th>单价</th><th>总价</th><th>备注</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 导出 CSV -->
    <section class="mt-10">
      <h2 class="text-2xl font-semibold text-blue-600">导出数据</h2>
      <button id="exportCSVBtn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">导出 CSV</button>
    </section>

    <!-- 库存记录 -->
    <section class="mt-10" id="inventoryRecordsSection">
      <h2 class="text-2xl font-semibold text-blue-600">库存记录</h2>
      <table id="recordsTable" class="mt-6 w-full table-auto bg-white shadow-md rounded-md">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th>客户名称</th><th>进出货</th><th>日期</th><th>版型</th><th>底版颜色</th>
            <th>花型</th><th>码数</th><th>数量</th><th>单价</th><th>总价</th><th>备注</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 编辑弹窗 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg w-96 max-h-[90vh] overflow-y-auto relative">
        <h2 class="text-xl font-semibold mb-4 sticky top-0 bg-white py-2">编辑记录</h2>
        <form id="editForm" class="space-y-4">
          <div>
            <label for="edit_customer_name" class="block text-sm font-medium">客户名称</label>
            <input type="text" id="edit_customer_name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_movement_type" class="block text-sm font-medium">进出货管理</label>
            <select id="edit_movement_type" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="IN">入库</option>
              <option value="OUT">出库</option>
            </select>
          </div>
          <div>
            <label for="edit_date" class="block text-sm font-medium">日期</label>
            <input type="date" id="edit_date" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_style" class="block text-sm font-medium">版型</label>
            <input type="text" id="edit_style" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_base_color" class="block text-sm font-medium">底版颜色</label>
            <input type="text" id="edit_base_color" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_pattern" class="block text-sm font-medium">花型</label>
            <input type="text" id="edit_pattern" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_size" class="block text-sm font-medium">码数</label>
            <input type="text" id="edit_size" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_quantity" class="block text-sm font-medium">数量（件）</label>
            <input type="number" id="edit_quantity" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_unit_price" class="block text-sm font-medium">单价</label>
            <input type="number" id="edit_unit_price" min="0" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_total_price" class="block text-sm font-medium">总价</label>
            <input type="number" id="edit_total_price" readonly step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label for="edit_note" class="block text-sm font-medium">备注</label>
            <input type="text" id="edit_note" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="flex justify-end mt-4 sticky bottom-0 bg-white py-2">
            <button type="button" id="cancelEdit" class="mr-2 px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">取消</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">更新</button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <script>
    const SUPABASE_URL = "https://oqwburiadlzlussbslbn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xd2J1cmlhZGx6bHVzc2JzbGJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTkzMTEsImV4cCI6MjA3Nzg5NTMxMX0.zUglY95hzH-qIvwqaMYkxrJVTYhaj040GfmrL6pYPms";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEditId = null;
    let currentData = [];

    function mainInventoryForm() {
      const form = document.getElementById("entryForm");
      const quantityInput = document.getElementById("quantity");
      const unitPriceInput = document.getElementById("unit_price");
      const totalPriceInput = document.getElementById("total_price");

      function updateTotal() {
        const q = Number(quantityInput.value)||0;
        const p = Number(unitPriceInput.value)||0;
        totalPriceInput.value = (q*p).toFixed(2);
      }

      quantityInput.addEventListener("input", updateTotal);
      unitPriceInput.addEventListener("input", updateTotal);

      form.addEventListener("submit", async e=>{
        e.preventDefault();
        const record = {
          customer_name: document.getElementById("customer_name").value,
          movement_type: document.getElementById("movement_type").value,
          date: document.getElementById("date").value,
          style: document.getElementById("style").value,
          base_color: document.getElementById("base_color").value,
          pattern: document.getElementById("pattern").value,
          size: document.getElementById("size").value,
          quantity: Number(document.getElementById("quantity").value),
          unit_price: Number(document.getElementById("unit_price").value),
          total_price: Number(document.getElementById("total_price").value),
          note: document.getElementById("note").value
        };
        const {error} = await supabaseClient.from('inventory_movements').insert([record]);
        if(error){alert("保存失败");console.error(error);return;}
        alert("记录保存成功！");
        form.reset(); totalPriceInput.value="";
        fetchRecords();
      });
    }

    function mainInventoryRecords() {
      const recordsTable = document.getElementById("recordsTable").querySelector("tbody");

      async function fetchRecords() {
        const {data,error} = await supabaseClient.from('inventory_movements').select('*').order('date',{ascending:false});
        if(error){console.error(error); return;}
        currentData = data;
        recordsTable.innerHTML="";
        data.forEach(r=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.customer_name}</td><td>${r.movement_type}</td><td>${r.date}</td>
                          <td>${r.style||''}</td><td>${r.base_color||''}</td><td>${r.pattern||''}</td>
                          <td>${r.size||''}</td><td>${r.quantity}</td><td>${r.unit_price}</td>
                          <td>${r.total_price}</td><td>${r.note||''}</td>
                          <td><button class="edit-btn text-blue-500" data-id="${r.id}">编辑</button> | 
                          <button class="delete-btn text-red-500" data-id="${r.id}">删除</button></td>`;
          recordsTable.appendChild(tr);
        });

        document.querySelectorAll('.edit-btn').forEach(btn=>btn.addEventListener('click',e=>openEditModal(e.target.dataset.id)));
        document.querySelectorAll('.delete-btn').forEach(btn=>btn.addEventListener('click',e=>deleteRecord(e.target.dataset.id)));
      }

      fetchRecords();
      return fetchRecords;
    }

    function mainExportModule(){
      const btn = document.getElementById("exportCSVBtn");
      btn.addEventListener("click",()=>{
        if(!currentData || currentData.length===0){alert("暂无数据可导出");return;}
        const headers = ["客户名称","进出货","日期","版型","底版颜色","花型","码数","数量","单价","总价","备注"];
        const csv = [headers.join(",")].concat(currentData.map(r=>[
          r.customer_name,r.movement_type,r.date,r.style||'',r.base_color||'',r.pattern||'',
          r.size||'',r.quantity,r.unit_price,r.total_price,r.note||''
        ].map(v=>`"${v}"`).join(","))).join("\n");
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url; a.download="export.csv"; a.click();
        URL.revokeObjectURL(url);
      });
    }

    function mainReport(){
      const form = document.getElementById("reportForm");
      const table = document.getElementById("reportTable");
      form.addEventListener("submit",async e=>{
        e.preventDefault();
        const start = document.getElementById("reportStartDate").value;
        const end = document.getElementById("reportEndDate").value;
        const customerFilter = document.getElementById("reportCustomer").value.trim();
        let query = supabaseClient.from('inventory_movements').select('*');
        if(start) query = query.gte('date',start);
        if(end) query = query.lte('date',end);
        if(customerFilter) query = query.ilike('customer_name', `%${customerFilter}%`);
        const {data,error} = await query.order('date',{ascending:false});
        if(error){console.error(error);return;}
        const tbody = table.querySelector("tbody");
        tbody.innerHTML="";
        data.forEach(r=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.customer_name}</td><td>${r.movement_type}</td><td>${r.date}</td>
                          <td>${r.style||''}</td><td>${r.base_color||''}</td><td>${r.pattern||''}</td>
                          <td>${r.size||''}</td><td>${r.quantity}</td><td>${r.unit_price}</td>
                          <td>${r.total_price}</td><td>${r.note||''}</td>`;
          tbody.appendChild(tr);
        });
        table.classList.remove("hidden");
      });
    }

    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const editQuantityInput = document.getElementById("edit_quantity");
    const editUnitPriceInput = document.getElementById("edit_unit_price");
    const editTotalPriceInput = document.getElementById("edit_total_price");

    function updateEditTotal(){
      const q = Number(editQuantityInput.value)||0;
      const p = Number(editUnitPriceInput.value)||0;
      editTotalPriceInput.value = (q*p).toFixed(2);
    }
    editQuantityInput.addEventListener("input",updateEditTotal);
    editUnitPriceInput.addEventListener("input",updateEditTotal);

    function openEditModal(id){
      const record = currentData.find(r=>r.id==id);
      if(!record) return;
      currentEditId=id;
      document.getElementById("edit_customer_name").value = record.customer_name;
      document.getElementById("edit_movement_type").value = record.movement_type;
      document.getElementById("edit_date").value = record.date;
      document.getElementById("edit_style").value = record.style||'';
      document.getElementById("edit_base_color").value = record.base_color||'';
      document.getElementById("edit_pattern").value = record.pattern||'';
      document.getElementById("edit_size").value = record.size||'';
      document.getElementById("edit_quantity").value = record.quantity;
      document.getElementById("edit_unit_price").value = record.unit_price;
      document.getElementById("edit_total_price").value = record.total_price;
      document.getElementById("edit_note").value = record.note||'';
      editModal.classList.remove("hidden");
    }

    document.getElementById("cancelEdit").addEventListener("click",()=>editModal.classList.add("hidden"));

    editForm.addEventListener("submit",async e=>{
      e.preventDefault();
      const record = {
        customer_name: document.getElementById("edit_customer_name").value,
        movement_type: document.getElementById("edit_movement_type").value,
        date: document.getElementById("edit_date").value,
        style: document.getElementById("edit_style").value,
        base_color: document.getElementById("edit_base_color").value,
        pattern: document.getElementById("edit_pattern").value,
        size: document.getElementById("edit_size").value,
        quantity: Number(document.getElementById("edit_quantity").value),
        unit_price: Number(document.getElementById("edit_unit_price").value),
        total_price: Number(document.getElementById("edit_total_price").value),
        note: document.getElementById("edit_note").value
      };
      const {error} = await supabaseClient.from('inventory_movements').update(record).eq('id',currentEditId);
      if(error){alert("更新失败");console.error(error);return;}
      alert("记录更新成功");
      editModal.classList.add("hidden");
      fetchRecords();
    });

    async function deleteRecord(id){
      if(!confirm("确认删除此记录吗？")) return;
      const {error} = await supabaseClient.from('inventory_movements').delete().eq('id',id);
      if(error){alert("删除失败");console.error(error);return;}
      alert("删除成功");
      fetchRecords();
    }

    let fetchRecords;
    window.onload=function(){
      mainInventoryForm();
      fetchRecords = mainInventoryRecords();
      mainReport();
      mainExportModule();
    };
  </script>

</body>
</html>
